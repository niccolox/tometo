---
- name: Checkout from Git
  git: repo={{ omotem_repo }} dest=/var/www/{{ checkout_dir }} version={{ checkout_branch }}
- name: Copy .env file
  template: src=env.j2 dest=/var/www/{{ checkout_dir }}/.env
- name: Install npm dependencies
  npm:
    path: /var/www/{{ checkout_dir }}
- name: Set up databases
  shell: source ~/.profile && diesel setup
  args:
    chdir: /var/www/{{ checkout_dir }}
    executable: /bin/bash
- name: Copy nginx file
  template: src=omotem.conf.j2 dest=/etc/nginx/conf.d/omotem.conf
  become: yes
  args:
    force: no
  notify:
    - restart nginx
- name: Copy systemd file
  template: src=systemd.j2 dest=/etc/systemd/system/omotem.service
  become: yes
  notify:
    - systemd reload
- name: Compile
  shell: source ~/.profile && cargo build --release
  args:
    chdir: /var/www/{{ checkout_dir }}
    executable: /bin/bash
  notify:
    - restart omotem
